<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CC Rationale Metadata Generator</title>
    <style>
        /* --- Color Variables --- */
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --primary-color: #0056b3;
            --secondary-color: #007bff;
            --border-color: #ccc;
            --border-light-color: #eee;
            --header-border-color: #0056b3;
            --form-bg-color: #fff;
            --form-shadow-color: rgba(0,0,0,0.1);
            --step-bg-color: #fff;
            --step-border-color: #eee;
            --label-color: #555;
            --input-bg-color: #fff;
            --input-border-color: #ccc;
            --input-focus-border-color: #007bff;
            --input-focus-shadow-color: rgba(0, 123, 255, 0.25);
            --helper-text-color: #666;
            --ref-library-bg-color: #f0f0f0;
            --ref-library-border-color: #ddd;
            --library-btn-bg-color: #17a2b8;
            --library-btn-hover-bg-color: #138496;
            --nav-btn-bg-color: #007bff;
            --nav-btn-hover-bg-color: #0056b3;
            --prev-btn-bg-color: #6c757d;
            --prev-btn-hover-bg-color: #5a6268;
            --verify-btn-bg-color: #ffc107;
            --verify-btn-text-color: #333;
            --verify-btn-hover-bg-color: #e0a800;
            --generate-btn-bg-color: #28a745;
            --generate-btn-hover-bg-color: #218838;
            --disabled-btn-bg-color: #adb5bd;
            --disabled-btn-text-color: #888; /* Disabled text color */
            --error-text-color: #721c24;
            --error-bg-color: #f8d7da;
            --error-border-color: #f5c6cb;
            --success-text-color: #155724;
            --success-bg-color: #d4edda;
            --success-border-color: #c3e6cb;
            --review-area-bg-color: #f8f9fa;
            --review-area-border-color: #dee2e6;
            --review-section-border-color: #ced4da;
            --review-h3-color: #495057;
            --review-label-color: #343a40;
            --review-block-bg-color: #fff;
            --review-block-border-color: #e9ecef;
            --review-list-item-color: #495057;
            --review-uri-color: #0056b3;
            --review-placeholder-color: #6c757d;
            --manual-ref-adder-bg-color: #f8f9fa;
            --manual-ref-adder-border-color: #dee2e6;
            --manual-add-btn-bg-color: #28a745;
            --manual-add-btn-hover-bg-color: #218838;
            --ref-display-h4-color: #666;
            --ref-list-item-bg-color: #e9ecef;
            --delete-ref-btn-bg-color: #dc3545;
            --delete-ref-btn-hover-bg-color: #c82333;
            --link-color: #0056b3;
            --select-arrow-svg-fill: '%23007bff'; /* Default blue for light mode */
            --dark-mode-toggle-bg: #444;
            --dark-mode-toggle-text: #fff;
            --dark-mode-toggle-hover-bg: #555;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --primary-color: #3b82f6;
            --secondary-color: #60a5fa;
            --border-color: #555;
            --border-light-color: #444;
            --header-border-color: #3b82f6;
            --form-bg-color: #2c2c2c;
            --form-shadow-color: rgba(0,0,0,0.4);
            --step-bg-color: #2c2c2c;
            --step-border-color: #444;
            --label-color: #bbb;
            --input-bg-color: #333;
            --input-border-color: #555;
            --input-focus-border-color: #60a5fa;
            --input-focus-shadow-color: rgba(96, 165, 250, 0.3);
            --helper-text-color: #aaa;
            --ref-library-bg-color: #252525;
            --ref-library-border-color: #4a4a4a;
            --library-btn-bg-color: #0e7490;
            --library-btn-hover-bg-color: #085f73;
            --nav-btn-bg-color: #3b82f6;
            --nav-btn-hover-bg-color: #2563eb;
            --prev-btn-bg-color: #52525b;
            --prev-btn-hover-bg-color: #3f3f46;
            --verify-btn-bg-color: #facc15;
            --verify-btn-text-color: #1a1a1a;
            --verify-btn-hover-bg-color: #eab308;
            --generate-btn-bg-color: #22c55e;
            --generate-btn-hover-bg-color: #16a34a;
            --disabled-btn-bg-color: #4b5563;
            --disabled-btn-text-color: #777; /* Disabled text color for dark mode */
            --error-text-color: #fca5a5;
            --error-bg-color: #7f1d1d;
            --error-border-color: #991b1b;
            --success-text-color: #a7f3d0;
            --success-bg-color: #14532d;
            --success-border-color: #166534;
            --review-area-bg-color: #252525;
            --review-area-border-color: #4a4a4a;
            --review-section-border-color: #555;
            --review-h3-color: #ccc;
            --review-label-color: #ddd;
            --review-block-bg-color: #333;
            --review-block-border-color: #4f4f4f;
            --review-list-item-color: #ccc;
            --review-uri-color: #60a5fa;
            --review-placeholder-color: #888;
            --manual-ref-adder-bg-color: #252525;
            --manual-ref-adder-border-color: #4a4a4a;
            --manual-add-btn-bg-color: #22c55e;
            --manual-add-btn-hover-bg-color: #16a34a;
            --ref-display-h4-color: #aaa;
            --ref-list-item-bg-color: #3a3a3a;
            --delete-ref-btn-bg-color: #ef4444;
            --delete-ref-btn-hover-bg-color: #dc2626;
            --link-color: #60a5fa;
            --select-arrow-svg-fill: '%23e0e0e0';
            --dark-mode-toggle-bg: #e0e0e0;
            --dark-mode-toggle-text: #1a1a1a;
            --dark-mode-toggle-hover-bg: #cccccc;
        }

        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 860px;
            margin: 0 auto 30px auto;
            padding: 0 10px;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            border-bottom: 2px solid var(--header-border-color);
            padding-bottom: 10px;
            margin-bottom: 0;
            flex-grow: 1;
        }

        #darkModeToggle {
            padding: 8px 12px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--dark-mode-toggle-bg);
            color: var(--dark-mode-toggle-text);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin-left: 20px;
        }
        #darkModeToggle:hover {
            background-color: var(--dark-mode-toggle-hover-bg);
        }

        h2 {
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h3 {
            color: var(--label-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        #metadata-form {
            background-color: var(--form-bg-color);
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--form-shadow-color);
            max-width: 800px;
            margin: auto;
        }

        .step {
            padding: 20px;
            border: 1px solid var(--step-border-color);
            margin-bottom: 25px;
            background-color: var(--step-bg-color);
            border-radius: 5px;
        }

        .step-status {
            font-size: 1.2em;
            font-weight: bold;
            margin-left: 15px;
            color: var(--generate-btn-bg-color);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .step-status.valid {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }
        .form-group label,
        .form-group-inline label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--label-color);
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group-inline input[type="number"] {
            width: 98%;
            max-width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            box-sizing: border-box;
        }
        .form-group select {
            padding: 10px 12px;
            height: auto;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22' + var(--select-arrow-svg-fill) + '%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: .65em auto;
            padding-right: 2.5em;
        }
        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-group-inline input[type="number"]:focus {
            border-color: var(--input-focus-border-color);
            outline: none;
            box-shadow: 0 0 0 2px var(--input-focus-shadow-color);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 0.88em;
            color: var(--helper-text-color);
        }
        #summary-char-count {
            font-weight: bold;
        }

        .form-group-inline {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .form-group-inline label {
             width: 180px;
             margin-bottom: 0;
             margin-right: 10px;
             flex-shrink: 0;
             text-align: right;
        }
        .form-group-inline input[type="number"] {
            width: 100px;
            flex-grow: 0;
            padding: 8px 10px;
        }

        .reference-library {
            background-color: var(--ref-library-bg-color);
            border: 1px solid var(--ref-library-border-color);
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 25px;
        }
        .library-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .library-add-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: var(--library-btn-bg-color);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .library-add-button:hover {
            background-color: var(--library-btn-hover-bg-color);
        }

        /* --- Navigation Buttons --- */
        .navigation-buttons {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light-color);
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }
        #step-6 .navigation-buttons {
            justify-content: space-between;
        }
        #step-6 .navigation-buttons > button#verify-button {
            margin-left: auto;
        }
        #step-6 .navigation-buttons > button#generate-button {
             margin-left: 10px;
        }

        /* General style for all navigation buttons, defaults to "Next" button style */
        .navigation-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            background-color: var(--nav-btn-bg-color); /* Default to Next button blue */
            color: white; /* Most nav buttons have white text */
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, opacity 0.3s ease;
        }
        .navigation-buttons button:hover:not(:disabled) {
            /* Default hover for "Next" or other buttons not specifically styled below for hover */
            background-color: var(--nav-btn-hover-bg-color);
        }
        .navigation-buttons button:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* Previous button style - Overrides general button style */
        .navigation-buttons button:first-child:not(:only-child) {
             background-color: var(--prev-btn-bg-color);
        }
        .navigation-buttons button:first-child:not(:only-child):hover:not(:disabled) {
            background-color: var(--prev-btn-hover-bg-color);
        }

        /* Verify button style - Overrides general button style */
        #verify-button { /* ID provides high specificity */
            background-color: var(--verify-btn-bg-color);
            color: var(--verify-btn-text-color);
        }
        #verify-button:hover:not(:disabled) {
            background-color: var(--verify-btn-hover-bg-color);
        }

        /* Generate button style - Overrides general button style */
        #generate-button { /* ID provides high specificity */
             background-color: var(--generate-btn-bg-color);
             color: white;
        }
        #generate-button:hover:not(:disabled) {
            background-color: var(--generate-btn-hover-bg-color);
        }

        /* Disabled button style - Overrides all others when disabled */
        .navigation-buttons button:disabled {
            background-color: var(--disabled-btn-bg-color);
            color: var(--disabled-btn-text-color);
            cursor: not-allowed;
            opacity: 0.65;
        }
        /* End of Navigation Button Style Changes */

        .error, #error-message, .manual-ref-message.error {
            color: var(--error-text-color);
            background-color: var(--error-bg-color);
            border: 1px solid var(--error-border-color);
            padding: 10px 15px;
            border-radius: 4px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }
        .manual-ref-message.error {
            margin-top: 10px;
            font-size: 0.9em;
            font-weight: normal;
        }

        #verification-status {
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            margin-top: 15px;
        }
        #verification-status.success {
            color: var(--success-text-color);
            background-color: var(--success-bg-color);
            border: 1px solid var(--success-border-color);
        }
        #verification-status.failure {
            color: var(--error-text-color);
            background-color: var(--error-bg-color);
            border: 1px solid var(--error-border-color);
        }

        #review-area {
            background-color: var(--review-area-bg-color);
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid var(--review-area-border-color);
            max-height: 600px;
            overflow-y: auto;
        }
        .review-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--review-section-border-color);
        }
        .review-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .review-section h3 {
            font-size: 1.2em;
            color: var(--review-h3-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: none;
        }
        .review-label {
            font-weight: bold;
            color: var(--review-label-color);
            display: inline-block;
            margin-right: 5px;
            vertical-align: top;
        }
        .review-section > p > .review-label {
            display: block;
            margin-bottom: 5px;
        }
        .review-value {
            color: var(--text-color);
            word-wrap: break-word;
            display: inline;
        }
        .review-section p {
            margin: 0 0 10px 0;
        }
        .review-block {
            display: block;
            background-color: var(--review-block-bg-color);
            border: 1px solid var(--review-block-border-color);
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 5px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            font-family: inherit;
            font-size: 1em;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            color: var(--text-color);
        }
        .review-section .review-block:last-child {
            margin-bottom: 0;
        }
        .review-list {
            list-style: none;
            padding-left: 10px;
            margin-top: 8px;
            margin-bottom: 0;
        }
        .review-list li {
            margin-bottom: 8px;
            color: var(--review-list-item-color);
            line-height: 1.5;
        }
        .review-list li .review-label {
            font-weight: bold;
            color: var(--review-label-color);
            margin-right: 8px;
        }
        .review-references li {
            font-family: sans-serif;
            font-size: 1em;
            word-break: break-all;
            line-height: 1.5;
        }
        .review-references li .review-label {
             display: inline-block;
             min-width: 150px;
        }
        .review-references li .ref-uri {
            font-family: monospace;
            color: var(--review-uri-color);
            margin-left: 5px;
        }
        .review-value em {
            color: var(--review-placeholder-color);
            font-style: italic;
        }

        .manual-reference-adder {
            background-color: var(--manual-ref-adder-bg-color);
            border: 1px solid var(--manual-ref-adder-border-color);
            padding: 15px 20px;
            border-radius: 5px;
            margin-top: 25px;
            margin-bottom: 25px;
        }
        .manual-reference-adder h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--label-color);
            border-bottom: none;
        }
        .manual-reference-adder .form-group {
            margin-bottom: 15px;
        }
        .manual-add-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: var(--manual-add-btn-bg-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 5px;
        }
        .manual-add-button:hover {
            background-color: var(--manual-add-btn-hover-bg-color);
        }

        .references-display-area {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }
        .references-display-area h4 {
            font-size: 1em;
            color: var(--ref-display-h4-color);
            margin-bottom: 10px;
            font-weight: bold;
        }
        .references-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 20px;
        }
        .references-list li {
            background-color: var(--ref-list-item-bg-color);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            flex-wrap: wrap;
        }
        .references-list li:last-child {
            margin-bottom: 0;
        }
        .references-list span {
            word-break: break-word;
        }
        .ref-display-label {
            font-weight: bold;
            margin-right: 5px;
            color: var(--review-label-color);
            flex-shrink: 0;
        }
        .ref-display-uri {
            color: var(--review-uri-color);
            flex-grow: 1;
            margin-right: 10px;
            word-break: break-all;
            min-width: 150px;
        }
        .selected-articles {
            font-size: 0.9em;
            color: var(--helper-text-color);
            margin-left: 10px;
            font-style: italic;
            flex-basis: 100%;
            margin-top: 4px;
        }
        .delete-ref-button {
            background-color: var(--delete-ref-btn-bg-color);
            color: white;
            border: none;
            padding: 3px 8px;
            font-size: 0.8em;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            margin-left: auto;
        }
        .delete-ref-button:hover {
            background-color: var(--delete-ref-btn-hover-bg-color);
        }
        .references-list li:only-child {
            background-color: transparent;
            font-style: italic;
            color: var(--review-placeholder-color);
            padding: 5px 0;
            justify-content: flex-start;
        }
        .review-subheading {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 5px;
            color: var(--review-h3-color);
            list-style-type: none !important;
            padding-left: 0;
            background-color: transparent !important;
        }
        .review-references li:first-child.review-subheading {
             margin-top: 0;
        }
        .review-selected-articles {
            font-size: 0.9em;
            color: var(--helper-text-color);
            font-style: italic;
            margin-left: 8px;
        }

        .constitution-selector {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--manual-ref-adder-bg-color);
            border: 1px solid var(--manual-ref-adder-border-color);
            border-radius: 5px;
        }
        #constitution-checkboxes-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--input-border-color);
            padding: 10px;
            background-color: var(--input-bg-color);
            margin-top: 8px;
            border-radius: 4px;
        }
        #constitution-checkboxes-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: normal;
            color: var(--text-color);
            cursor: pointer;
        }
        #constitution-checkboxes-container input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
            cursor: pointer;
        }
        #constitution-checkboxes-container label:last-child {
            margin-bottom: 0;
        }

        a {
            color: var(--link-color);
            text-decoration: underline;
        }
        a:hover {
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h1>CC Rationale Metadata Generator</h1>
        <button id="darkModeToggle">Toggle Dark Mode</button>
    </div>

    <form id="metadata-form" onsubmit="return false;">

        <div class="step" id="step-1">
            <h2>Step 1: Basic Information <span class="step-status" id="status-step-1"></span></h2>
            <div class="form-group">
                <label for="hashAlgorithm">Hash Algorithm:</label>
                <input type="text" id="hashAlgorithm" placeholder="e.g., blake2b-256" value="blake2b-256" required>
                <small>Hashing algorithm used (e.g., blake2b-256).</small>
            </div>
            <div class="form-group">
                <label for="subject">Subject:</label>
                <input type="text" id="subject" placeholder="e.g., Rationale for Vote on GovAction XYZ-123">
                <small>A concise title or subject (Optional, not in final JSON structure, but used for filename).</small>
            </div>
            <div class="form-group">
                <label for="authors">Author(s):</label>
                <textarea id="authors" rows="3" placeholder="Enter one author name per line or separate by semicolons. E.g., Org Name; Individual Name" required></textarea>
                 <small>Name of the CC member(s) authoring this rationale. Required.</small>
            </div>
            <div class="navigation-buttons">
                <button type="button" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div class="step" id="step-2" style="display: none;">
             <h2>Step 2: Core Rationale (Compulsory) <span class="step-status" id="status-step-2"></span></h2>
            <div class="form-group">
                <label for="summary">Summary:</label>
                <textarea id="summary" rows="4" maxlength="300" required></textarea>
                <small>Short statement (Max 300 chars). <span id="summary-char-count">0</span>/300</small>
            </div>
            <div class="form-group">
                <label for="rationaleStatement">Rationale Statement:</label>
                <textarea id="rationaleStatement" rows="10" required></textarea>
                <small>Full rationale. Markdown supported.</small>
            </div>
            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Previous</button>
                <button type="button" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div class="step" id="step-3" style="display: none;">
             <h2>Step 3: Supporting Discussion (Optional) <span class="step-status" id="status-step-3"></span></h2>
            <div class="form-group">
                <label for="precedentDiscussion">Precedent Discussion:</label>
                <textarea id="precedentDiscussion" rows="6"></textarea>
                <small>Discuss relevant precedent. Markdown supported.</small>
            </div>
            <div class="form-group">
                <label for="counterargumentDiscussion">Counterargument Discussion:</label>
                <textarea id="counterargumentDiscussion" rows="6"></textarea>
                <small>Discuss significant counterarguments. Markdown supported.</small>
            </div>
            <div class="form-group">
                <label for="conclusion">Conclusion:</label>
                <textarea id="conclusion" rows="4"></textarea>
                <small>Concluding remarks. Markdown NOT supported.</small>
            </div>
            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Previous</button>
                <button type="button" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div class="step" id="step-4" style="display: none;">
             <h2>Step 4: Internal Voting (Optional) <span class="step-status" id="status-step-4"></span></h2>
            <p>If this CC member represents an organization/consortium with internal voting, provide the breakdown below.</p>
            <div class="form-group-inline">
                <label for="internal_constitutional_votes">Constitutional Votes:</label>
                <input type="number" id="internal_constitutional_votes" min="0" step="1">
            </div>
            <div class="form-group-inline">
                <label for="internal_unconstitutional_votes">Unconstitutional Votes:</label>
                <input type="number" id="internal_unconstitutional_votes" min="0" step="1">
            </div>
            <div class="form-group-inline">
                <label for="internal_abstain_votes">Abstain Votes:</label>
                <input type="number" id="internal_abstain_votes" min="0" step="1">
            </div>
            <div class="form-group-inline">
                <label for="internal_did_not_vote">Did Not Vote:</label>
                <input type="number" id="internal_did_not_vote" min="0" step="1">
            </div>
            <div class="form-group-inline">
                <label for="internal_against_vote">Votes Against Voting:</label>
                <input type="number" id="internal_against_vote" min="0" step="1">
                <small style="margin-left: 10px; width: auto;">(Note: This field is not part of the standard reference JSON structure)</small>
            </div>
            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Previous</button>
                <button type="button" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div class="step" id="step-5" style="display: none;">
             <h2>Step 5: References <span class="step-status" id="status-step-5"></span></h2>

             <div class="reference-library">
                <h3>Reference Library</h3>
                <div class="form-group">
                    <label for="library-select">Select a common reference:</label>
                    <select id="library-select" class="form-control">
                        <option value="">-- Select --</option>
                        </select>
                </div>
                <div class="library-buttons">
                    <button type="button" class="library-add-button" onclick="addLibraryReference('relevant')">Add to Relevant Articles</button>
                    <button type="button" class="library-add-button" onclick="addLibraryReference('other')">Add to Other References</button>
                </div>
            </div>

            <div class="manual-reference-adder">
                <h3>Add Manual Reference</h3>
                <div class="form-group">
                    <label for="manualRefLabel">Reference Label:</label>
                    <input type="text" id="manualRefLabel" placeholder="e.g., Constitution Article III">
                </div>
                <div class="form-group">
                    <label for="manualRefUri">Reference URI:</label>
                    <input type="text" id="manualRefUri" placeholder="e.g., cardano:constitution:article-III or https://...">
                </div>
                <div class="form-group">
                     <label for="manualRefTarget">Add to:</label>
                     <select id="manualRefTarget">
                         <option value="relevant">Relevant Constitution Articles</option>
                         <option value="other">Other References</option>
                     </select>
                </div>
                <button type="button" class="manual-add-button" onclick="addManualReference()">Add Manual Reference</button>
                <div id="manual-ref-error" class="manual-ref-message error" style="display: none;"></div>
            </div>

            <div class="references-display-area">
                <h4>Added Relevant Articles:</h4>
                <ul id="relevantArticlesDisplay" class="references-list">
                    </ul>

                <div id="constitution-articles-selector" style="display: none;" class="form-group constitution-selector">
                    <label>Select Relevant Constitution Sections/Articles:</label>
                    <div id="constitution-checkboxes-container">
                        </div>
                    <small>Select all applicable sections for the rationale.</small>
                </div>
                <h4>Added Other References:</h4>
                <ul id="otherReferencesDisplay" class="references-list">
                     </ul>
            </div>

            <p style="margin-top: 20px;">
                Want to add to the reference library? Please submit a pull request on GitHub:
                <a href="https://github.com/Thomas-nada/Council-rationale-generator" target="_blank" rel="noopener noreferrer">
                    https://github.com/Thomas-nada/Council-rationale-generator
                </a>
            </p>

            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Previous</button>
                <button type="button" onclick="nextStep()">Next</button>
            </div>
        </div>
        <div class="step" id="step-6" style="display: none;">
             <h2>Step 6: Review and Generate</h2>
            <p>Please review the information below. Go back to previous steps to make changes if necessary. Click "Verify Metadata" to check for required fields before generating the file.</p>
            <div id="review-area">
                </div>
            <div id="verification-status" style="margin-top: 15px;"></div>
            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Previous</button>
                <button type="button" id="verify-button" onclick="verifyMetadata()">Verify Metadata</button>
                <button type="button" id="generate-button" onclick="generateJson()" disabled>Generate JSON File</button>
            </div>
            <div id="error-message" class="error" style="display: none;"></div>
        </div>

    </form>

    <script>
        // Global variable to track the current step
        let currentStep = 1;
        // Object to store input data collected from all steps
        const formData = {};
        formData.manualRelevantArticles = []; // Array to store relevant articles references { label, uri, selectedArticles? }
        formData.manualOtherReferences = []; // Array to store other references { label, uri }
        // Total number of steps in the form
        const totalSteps = 6; // Remains 6 steps (incl. review)
        // Object to track the validation status of each step
        const stepValidity = {};

        // --- Reference Library Definition ---
        const referenceLibrary = [
            { label: "Cardano Blockchain Ecosystem Constitution", uri: "ipfs://bafkreiazhhawe7sjwuthcfgl3mmv2swec7sukvclu3oli7qdyz4uhhuvmy", isConstitution: true }, // Added flag
            { label: "GovTool", uri: "https://gov.tools/" },
            { label: "CIP-100 (Governance Metadata)", uri: "https://cips.cardano.org/cip/CIP-0100" },
            { label: "CIP-136 (CC Vote Metadata)", uri: "https://cips.cardano.org/cip/CIP-0136" },
            { label: "CIP-1694 (Governance Framework)", uri: "https://cips.cardano.org/cip/CIP-1694" },
            // Add more common references here
        ];

        // Constitution Articles (as before)
        const constitutionArticles = [
            "PREAMBLE","TENET 1","TENET 2","TENET 3","TENET 4","TENET 5","TENET 6","TENET 7","TENET 8","TENET 9","TENET 10",
            "Article I Section 1","Article I Section 2",
            "Article II Section 1","Article II Section 2","Article II Section 3","Article II Section 4",
            "Article III Section 1","Article III Section 2","Article III Section 3","Article III Section 4","Article III Section 5","Article III Section 6",
            "Article IV Section 1","Article IV Section 2","Article IV Section 3","Article IV Section 4","Article IV Section 5",
            "Article V Section 1","Article V Section 2","Article V Section 3","Article V Section 4","Article V Section 5","Article V Section 6",
            "Article VI Section 1","Article VI Section 2","Article VI Section 3","Article VI Section 4",
            "Article VII Section 1","Article VII Section 2","Article VII Section 3","Article VII Section 4","Article VII Section 5","Article VII Section 6","Article VII Section 7","Article VII Section 8","Article VII Section 9",
            "Article VIII Section 1","Article VIII Section 2","Article VIII Section 3",
            "Appendix I Section 1: Introduction","Appendix I Section 1: Amending, Adding or Deprecating Guardrails","Appendix I Section 1: Terminology and Guidance","Appendix I Section 1: Automated Checking ('Guardrails Script')",
            "Appendix I Section 2: Protocol Parameter Update Actions","Appendix I Section 2.1: Critical Protocol Parameters","Appendix I Section 2.2: Economic Parameters","Appendix I Section 2.3: Network Parameters","Appendix I Section 2.4: Technical/Security Parameters","Appendix I Section 2.5: Governance Parameters","Appendix I Section 2.6: Monitoring and Reversion","Appendix I Section 2.7: Non-Updatable Parameters",
            "Appendix I Section 3: Treasury Withdrawal Actions","Appendix I Section 4: Hard Fork Initiation Actions","Appendix I Section 5: Update CC or Threshold Actions","Appendix I Section 6: New Constitution/Script Actions","Appendix I Section 7: No Confidence Actions","Appendix I Section 8: Info Actions","Appendix I Section 9: List of Protocol Parameter Groups",
            "Appendix II Section 1: Framing Notes","Appendix II Section 2: Other Guidance"
        ];

        // --- DOMContentLoaded Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            const darkModeToggle = document.getElementById('darkModeToggle');

            // Check for saved theme preference
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                if (darkModeToggle) darkModeToggle.textContent = 'Switch to Light Mode';
            } else {
                 if (darkModeToggle) darkModeToggle.textContent = 'Switch to Dark Mode';
            }


            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    if (document.body.classList.contains('dark-mode')) {
                        localStorage.setItem('theme', 'dark');
                        darkModeToggle.textContent = 'Switch to Light Mode';
                    } else {
                        localStorage.setItem('theme', 'light');
                        darkModeToggle.textContent = 'Switch to Dark Mode';
                    }
                });
            }

            showStep(1);
            populateReferenceLibraryDropdown();
            updateReferenceDisplay('relevant');
            updateReferenceDisplay('other');
            hideConstitutionSelector();

            const summaryTextarea = document.getElementById('summary');
            const summaryCharCount = document.getElementById('summary-char-count');
            if (summaryTextarea && summaryCharCount) {
                summaryCharCount.textContent = summaryTextarea.value.length;
                summaryTextarea.addEventListener('input', () => {
                    const count = summaryTextarea.value.length;
                    summaryCharCount.textContent = count;
                    summaryCharCount.style.color = count > 300 ? 'red' : 'inherit';
                });
            }
            const errorDiv = document.getElementById('error-message');
            if(errorDiv) errorDiv.style.display = 'none';
        });


        // --- Reference Library Functions (largely unchanged, ensure DOM elements exist) ---
        function populateReferenceLibraryDropdown() {
            const selectElement = document.getElementById('library-select');
            if (!selectElement) return;
            referenceLibrary.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = item.label;
                selectElement.appendChild(option);
            });
        }

        function addLibraryReference(targetType) {
            const selectElement = document.getElementById('library-select');
            const errorDiv = document.getElementById('manual-ref-error');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }

            if (!selectElement || selectElement.value === "") {
                if (errorDiv) {
                    errorDiv.textContent = 'Please select a reference from the library.';
                    errorDiv.style.display = 'block';
                }
                return;
            }
            const selectedIndex = parseInt(selectElement.value, 10);
            const selectedRef = referenceLibrary[selectedIndex];

            if (selectedRef) {
                const newRef = { label: selectedRef.label, uri: selectedRef.uri, isConstitution: selectedRef.isConstitution || false };
                if (targetType === 'relevant') {
                    if (!formData.manualRelevantArticles.some(ref => ref.uri === newRef.uri)) {
                        if (newRef.isConstitution) {
                            newRef.selectedArticles = [];
                            showConstitutionSelector(formData.manualRelevantArticles.length);
                        }
                        formData.manualRelevantArticles.push(newRef);
                        updateReferenceDisplay('relevant');
                    } else {
                        if (errorDiv) { errorDiv.textContent = 'This library reference is already in Relevant Articles.'; errorDiv.style.display = 'block'; }
                    }
                } else if (targetType === 'other') {
                    if (!formData.manualOtherReferences.some(ref => ref.uri === newRef.uri)) {
                        formData.manualOtherReferences.push(newRef);
                        updateReferenceDisplay('other');
                        if (newRef.isConstitution && !formData.manualRelevantArticles.some(r => r.isConstitution)) {
                            hideConstitutionSelector();
                        }
                    } else {
                         if (errorDiv) { errorDiv.textContent = 'This library reference is already in Other References.'; errorDiv.style.display = 'block'; }
                    }
                }
            } else {
                 if (errorDiv) { errorDiv.textContent = 'Could not find selected library reference.'; errorDiv.style.display = 'block'; }
            }
        }

        function addManualReference() {
            const labelInput = document.getElementById('manualRefLabel');
            const uriInput = document.getElementById('manualRefUri');
            const targetSelect = document.getElementById('manualRefTarget');
            const errorDiv = document.getElementById('manual-ref-error');

            const label = labelInput.value.trim();
            const uri = uriInput.value.trim();
            const targetType = targetSelect.value;

            if (errorDiv) { errorDiv.textContent = ''; errorDiv.style.display = 'none'; }

            if (!label) { if (errorDiv) { errorDiv.textContent = 'Please enter a Reference Label.'; errorDiv.style.display = 'block';} labelInput.focus(); return; }
            if (!uri) { if (errorDiv) { errorDiv.textContent = 'Please enter a Reference URI.'; errorDiv.style.display = 'block';} uriInput.focus(); return; }
            if (!uri.includes(':') && !uri.includes('.')) { if (errorDiv) { errorDiv.textContent = 'Please enter a valid URI.'; errorDiv.style.display = 'block';} uriInput.focus(); return; }

            const isConstitution = (label === "Cardano Blockchain Ecosystem Constitution");
            const newRef = { label: label, uri: uri, isConstitution: isConstitution };

            if (targetType === 'relevant') {
                if (!formData.manualRelevantArticles.some(ref => ref.uri === newRef.uri)) {
                    if (newRef.isConstitution) { newRef.selectedArticles = []; showConstitutionSelector(formData.manualRelevantArticles.length); }
                    formData.manualRelevantArticles.push(newRef);
                    updateReferenceDisplay('relevant');
                    labelInput.value = ''; uriInput.value = '';
                } else {
                    if (errorDiv) { errorDiv.textContent = 'This URI is already in Relevant Articles.'; errorDiv.style.display = 'block'; }
                }
            } else if (targetType === 'other') {
                if (!formData.manualOtherReferences.some(ref => ref.uri === newRef.uri)) {
                    formData.manualOtherReferences.push(newRef);
                    updateReferenceDisplay('other');
                    if (newRef.isConstitution && !formData.manualRelevantArticles.some(r => r.isConstitution)) { hideConstitutionSelector(); }
                    labelInput.value = ''; uriInput.value = '';
                } else {
                    if (errorDiv) { errorDiv.textContent = 'This URI is already in Other References.'; errorDiv.style.display = 'block'; }
                }
            }
        }

        function updateReferenceDisplay(targetType) {
            let displayListElement = (targetType === 'relevant') ? document.getElementById('relevantArticlesDisplay') : document.getElementById('otherReferencesDisplay');
            let referenceArray = (targetType === 'relevant') ? formData.manualRelevantArticles : formData.manualOtherReferences;

            if (!displayListElement) return;
            displayListElement.innerHTML = '';

            if (referenceArray.length === 0) {
                displayListElement.innerHTML = '<li>No references added yet.</li>';
            } else {
                referenceArray.forEach((ref, index) => {
                    const listItem = document.createElement('li');
                    let selectedArticlesHtml = '';
                    if (ref.isConstitution && ref.selectedArticles && ref.selectedArticles.length > 0 && targetType === 'relevant') {
                        selectedArticlesHtml = `<span class="selected-articles">(Selected: ${escapeHtml(ref.selectedArticles.join(', '))})</span>`;
                    }
                    listItem.innerHTML = `
                        <span class="ref-display-label">${escapeHtml(ref.label)}:</span>
                        <span class="ref-display-uri">${escapeHtml(ref.uri)}</span>
                        ${selectedArticlesHtml}
                        <button type="button" class="delete-ref-button" onclick="deleteReference('${targetType}', ${index})">Delete</button>
                    `;
                    displayListElement.appendChild(listItem);
                });
            }
        }

        function deleteReference(targetType, index) {
            let referenceArray = (targetType === 'relevant') ? formData.manualRelevantArticles : formData.manualOtherReferences;
            let isRelevant = (targetType === 'relevant');

            if (index >= 0 && index < referenceArray.length) {
                const deletedRef = referenceArray[index];
                referenceArray.splice(index, 1);
                if (isRelevant && deletedRef.isConstitution) {
                    const constitutionStillRelevant = formData.manualRelevantArticles.some(ref => ref.isConstitution);
                    if (!constitutionStillRelevant) {
                        hideConstitutionSelector();
                    } else {
                        const remainingConstIndex = formData.manualRelevantArticles.findIndex(ref => ref.isConstitution);
                        if(remainingConstIndex > -1) { showConstitutionSelector(remainingConstIndex); }
                    }
                }
                updateReferenceDisplay(targetType);
            }
        }

        function showConstitutionSelector(referenceIndex) {
            const selectorDiv = document.getElementById('constitution-articles-selector');
            const checkboxesContainer = document.getElementById('constitution-checkboxes-container');
            if (!selectorDiv || !checkboxesContainer) return;
            checkboxesContainer.innerHTML = '';
            const currentSelections = formData.manualRelevantArticles[referenceIndex]?.selectedArticles || [];
            constitutionArticles.forEach(article => {
                if (article.startsWith("//")) return;
                const checkboxId = `const-art-${article.replace(/[\s\W]+/g, '-')}`;
                const isChecked = currentSelections.includes(article);
                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.id = checkboxId; checkbox.value = article; checkbox.checked = isChecked;
                checkbox.addEventListener('change', (event) => {
                    const currentConstRef = formData.manualRelevantArticles[referenceIndex];
                    if (!currentConstRef) return;
                    const currentConstIndexInFormData = formData.manualRelevantArticles.findIndex(ref => ref.uri === currentConstRef.uri && ref.isConstitution);
                    if (currentConstIndexInFormData > -1) {
                        updateConstitutionSelections(currentConstIndexInFormData, event.target.value, event.target.checked);
                        updateReferenceDisplay('relevant');
                    }
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${article}`));
                checkboxesContainer.appendChild(label);
            });
            selectorDiv.style.display = 'block';
        }

        function hideConstitutionSelector() {
            const selectorDiv = document.getElementById('constitution-articles-selector');
            const checkboxesContainer = document.getElementById('constitution-checkboxes-container');
            if (selectorDiv) selectorDiv.style.display = 'none';
            if (checkboxesContainer) checkboxesContainer.innerHTML = '';
        }

        function updateConstitutionSelections(referenceIndexInFormData, articleValue, isChecked) {
            if (formData.manualRelevantArticles[referenceIndexInFormData]?.isConstitution) {
                if (!formData.manualRelevantArticles[referenceIndexInFormData].selectedArticles) {
                    formData.manualRelevantArticles[referenceIndexInFormData].selectedArticles = [];
                }
                const selections = formData.manualRelevantArticles[referenceIndexInFormData].selectedArticles;
                if (isChecked && !selections.includes(articleValue)) { selections.push(articleValue); }
                else if (!isChecked) {
                    const indexToRemove = selections.indexOf(articleValue);
                    if (indexToRemove > -1) { selections.splice(indexToRemove, 1); }
                }
                selections.sort((a, b) => {
                    const mainList = constitutionArticles.filter(item => !item.startsWith("//"));
                    return mainList.indexOf(a) - mainList.indexOf(b);
                });
            }
        }

        // --- Step Navigation and Validation Functions ---
        function updateStepStatusDisplay(stepNumber) {
            const statusElement = document.getElementById(`status-step-${stepNumber}`);
            if (statusElement) {
                if (stepValidity[stepNumber]) { statusElement.textContent = '✓'; statusElement.classList.add('valid'); }
                else { statusElement.textContent = ''; statusElement.classList.remove('valid'); }
            }
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.style.display = 'none');
            const stepToShow = document.getElementById(`step-${stepNumber}`);
            if (stepToShow) {
                stepToShow.style.display = 'block';
                updateStepStatusDisplay(stepNumber);
                if (stepNumber === totalSteps) {
                    populateReviewArea();
                    const genBtn = document.getElementById('generate-button'); if(genBtn) genBtn.disabled = true;
                    const verStatus = document.getElementById('verification-status'); if(verStatus) {verStatus.textContent = ''; verStatus.className = '';}
                    const errMsg = document.getElementById('error-message'); if(errMsg) {errMsg.textContent = ''; errMsg.style.display = 'none';}
                }
            }
            currentStep = stepNumber;
        }

        function validateStep(stepNumber, showAlerts = true) {
            const stepElement = document.getElementById(`step-${stepNumber}`);
            if (!stepElement) return false;
            const requiredInputs = stepElement.querySelectorAll('input[required], textarea[required]');
            let isValid = true; let firstErrorMessage = '';
            requiredInputs.forEach(input => {
                if (isValid && !input.value.trim()) {
                    const fieldLabel = input.previousElementSibling?.textContent || input.id;
                    const fieldName = input.id === 'hashAlgorithm' ? 'Hash Algorithm' : fieldLabel.replace(':', '').trim();
                    firstErrorMessage = `Please fill in the required field: ${fieldName}`;
                    // Conditional alert only in browser environment
                    if (showAlerts && typeof window !== 'undefined' && typeof window.alert === 'function') alert(firstErrorMessage);
                    input.focus(); isValid = false;
                }
            });
            if (!isValid) { stepValidity[stepNumber] = false; return false; }
            if (stepNumber === 2) {
                const summary = document.getElementById('summary').value;
                if (summary.length > 300) {
                    firstErrorMessage = 'Summary must not exceed 300 characters.';
                    if (showAlerts && typeof window !== 'undefined' && typeof window.alert === 'function') alert(firstErrorMessage);
                    document.getElementById('summary').focus(); isValid = false;
                }
            } else if (stepNumber === 4) {
                const numberInputs = stepElement.querySelectorAll('input[type="number"]');
                numberInputs.forEach(input => {
                    if (isValid && input.value && parseInt(input.value, 10) < 0) {
                        const fieldLabel = input.previousElementSibling?.textContent || input.id;
                        firstErrorMessage = `Internal vote count for ${fieldLabel.replace(':', '').trim()} cannot be negative.`;
                        if (showAlerts && typeof window !== 'undefined' && typeof window.alert === 'function') alert(firstErrorMessage);
                        input.focus(); isValid = false;
                    }
                });
            }
            stepValidity[stepNumber] = isValid; return isValid;
        }

        function runFinalValidation() {
            const requiredSteps = [1, 2]; let overallValid = true;
            let finalMessage = "Verification successful. Ready to generate JSON.";
            for (const stepNum of requiredSteps) {
                if (!validateStep(stepNum, false)) {
                    overallValid = false;
                    const stepElement = document.getElementById(`step-${stepNum}`);
                    let firstInvalidInput = null;
                    if (stepElement) {
                        const reqInputs = stepElement.querySelectorAll('input[required], textarea[required]');
                        for(const input of reqInputs) { if(!input.value.trim()) { firstInvalidInput = input; break; } }
                    }
                    const fieldLabel = firstInvalidInput?.previousElementSibling?.textContent || `a required field in Step ${stepNum}`;
                    const fieldName = firstInvalidInput?.id === 'hashAlgorithm' ? 'Hash Algorithm' : fieldLabel.replace(':', '').trim();
                    finalMessage = `Verification failed: Please check ${fieldName}.`;
                    showStep(stepNum); break;
                }
            }
            if (overallValid) {
                const summary = document.getElementById('summary').value;
                if (summary.length > 300) { overallValid = false; finalMessage = 'Verification failed: Summary exceeds 300 characters.'; showStep(2); }
                const step4Element = document.getElementById('step-4');
                if (step4Element) {
                    const numberInputs = step4Element.querySelectorAll('input[type="number"]');
                    numberInputs.forEach(input => {
                        if (overallValid && input.value && parseInt(input.value, 10) < 0) {
                            overallValid = false; const fieldLabel = input.previousElementSibling?.textContent || input.id;
                            finalMessage = `Verification failed: Internal vote count for ${fieldLabel.replace(':', '').trim()} cannot be negative.`; showStep(4);
                        }
                    });
                }
            }
            return { isValid: overallValid, message: finalMessage };
        }

        function collectStepData(stepNumber) {
            const stepElement = document.getElementById(`step-${stepNumber}`);
            if (!stepElement) return;
            const inputs = stepElement.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.id !== 'manualRefLabel' && input.id !== 'manualRefUri' && input.id !== 'manualRefTarget' && input.id !== 'library-select' && !input.id.startsWith('const-art-')) {
                    formData[input.id] = input.value.trim();
                }
            });
            if (stepNumber === 4) {
                const numberIds = ['internal_constitutional_votes', 'internal_unconstitutional_votes', 'internal_abstain_votes', 'internal_did_not_vote', 'internal_against_vote'];
                numberIds.forEach(id => {
                    const input = document.getElementById(id);
                    if (input && input.value.trim() !== '') {
                        const value = parseInt(input.value, 10);
                        formData[id] = (!isNaN(value) && value >= 0) ? value : null;
                    } else { formData[id] = null; }
                });
            }
        }

        function nextStep() {
            const isValid = validateStep(currentStep);
            updateStepStatusDisplay(currentStep);
            if (isValid) { collectStepData(currentStep); if (currentStep < totalSteps) { showStep(currentStep + 1); } }
        }

        function prevStep() {
            collectStepData(currentStep); if (currentStep > 1) { showStep(currentStep - 1); }
        }

        function parseAuthors(authorsString) {
            if (!authorsString) return [];
            return authorsString.split(/[\n;]+/).map(a => a.trim()).filter(a => a).map(name => ({ name: name }));
        }

        function buildMetadata() {
            const context = { /* ... as before ... */
                "@language": "en-us", "CIP100": "https://github.com/cardano-foundation/CIPs/blob/master/CIP-0100/README.md#", "CIP136": "https://github.com/cardano-foundation/CIPs/blob/master/CIP-0136/README.md#", "hashAlgorithm": "CIP100:hashAlgorithm",
                "body": { "@id": "CIP136:body", "@context": { "references": { "@id": "CIP100:references", "@container": "@set", "@context": { "GovernanceMetadata": "CIP100:GovernanceMetadataReference", "Other": "CIP100:OtherReference", "label": "CIP100:reference-label", "uri": "CIP100:reference-uri", "RelevantArticles": "CIP136:RelevantArticles" } }, "summary": "CIP136:summary", "rationaleStatement": "CIP136:rationaleStatement", "precedentDiscussion": "CIP136:precedentDiscussion", "counterargumentDiscussion": "CIP136:counterargumentDiscussion", "conclusion": "CIP136:conclusion", "internalVote": { "@id": "CIP136:internalVote", "@context": { "constitutional": "CIP136:constitutional", "unconstitutional": "CIP136:unconstitutional", "abstain": "CIP136:abstain", "didNotVote": "CIP136:didNotVote" } } } },
                "authors": { "@id": "CIP100:authors", "@container": "@set", "@context": { "did": "@id", "name": "http://xmlns.com/foaf/0.1/name", "witness": { "@id": "CIP100:witness", "@context": { "witnessAlgorithm": "CIP100:witnessAlgorithm", "publicKey": "CIP100:publicKey", "signature": "CIP100:signature" } } } }
            };
            const metadata = { "@context": context, "hashAlgorithm": formData.hashAlgorithm || "blake2b-256", "body": { "summary": formData.summary || "", "rationaleStatement": formData.rationaleStatement || "" }, "authors": parseAuthors(formData.authors || "") };
            const body = metadata.body;
            if (formData.precedentDiscussion) body.precedentDiscussion = formData.precedentDiscussion;
            if (formData.counterargumentDiscussion) body.counterargumentDiscussion = formData.counterargumentDiscussion;
            if (formData.conclusion) body.conclusion = formData.conclusion;
            const internalVoteData = {};
            if (formData.internal_constitutional_votes !== null && formData.internal_constitutional_votes !== undefined) internalVoteData.constitutional = formData.internal_constitutional_votes;
            if (formData.internal_unconstitutional_votes !== null && formData.internal_unconstitutional_votes !== undefined) internalVoteData.unconstitutional = formData.internal_unconstitutional_votes;
            if (formData.internal_abstain_votes !== null && formData.internal_abstain_votes !== undefined) internalVoteData.abstain = formData.internal_abstain_votes;
            if (formData.internal_did_not_vote !== null && formData.internal_did_not_vote !== undefined) internalVoteData.didNotVote = formData.internal_did_not_vote;
            if (Object.keys(internalVoteData).length > 0) body.internalVote = internalVoteData;
            const allReferences = [];
            const processReference = (ref) => { const referenceObject = { "@type": "Other", label: ref.label, uri: ref.uri }; if (ref.isConstitution && ref.selectedArticles && ref.selectedArticles.length > 0) { referenceObject.RelevantArticles = ref.selectedArticles.join(', '); } allReferences.push(referenceObject); };
            (formData.manualRelevantArticles || []).forEach(processReference);
            (formData.manualOtherReferences || []).forEach(processReference);
            if (allReferences.length > 0) { body.references = allReferences; }
            return metadata;
        }

        function populateReviewArea() {
            const reviewArea = document.getElementById('review-area');
            if (!reviewArea) return;
            let reviewHtml = '';
            if (formData.hashAlgorithm || formData.subject || formData.authors) {
                reviewHtml += `<div class="review-section"><h3>Basic Information</h3>`;
                if (formData.hashAlgorithm) reviewHtml += `<p><span class="review-label">Hash Algorithm:</span> <span class="review-value">${escapeHtml(formData.hashAlgorithm)}</span></p>`;
                if (formData.subject) reviewHtml += `<p><span class="review-label">Subject (for filename):</span> <span class="review-value">${escapeHtml(formData.subject)}</span></p>`;
                const authorsList = parseAuthors(formData.authors || "");
                if (authorsList.length > 0) { reviewHtml += `<p><span class="review-label">Authors:</span> <span class="review-value">${authorsList.map(a => escapeHtml(a.name)).join('; ')}</span></p>`; }
                else if (formData.authors) { reviewHtml += `<p><span class="review-label">Authors:</span> <span class="review-value">${escapeHtml(formData.authors)}</span></p>`; }
                else { reviewHtml += `<p><span class="review-label">Authors:</span> <span class="review-value"><em>Not provided</em></span></p>`;}
                reviewHtml += `</div>`;
            }
            if (formData.summary || formData.rationaleStatement) {
                reviewHtml += `<div class="review-section"><h3>Core Rationale</h3>`;
                if (formData.summary) reviewHtml += `<p><span class="review-label">Summary:</span></p><pre class="review-value review-block">${escapeHtml(formData.summary)}</pre>`;
                else reviewHtml += `<p><span class="review-label">Summary:</span> <span class="review-value"><em>Not provided</em></span></p>`;
                if (formData.rationaleStatement) reviewHtml += `<p><span class="review-label">Rationale Statement:</span></p><pre class="review-value review-block">${escapeHtml(formData.rationaleStatement)}</pre>`;
                else reviewHtml += `<p><span class="review-label">Rationale Statement:</span> <span class="review-value"><em>Not provided</em></span></p>`;
                reviewHtml += `</div>`;
            }
            let optDiscHtml = '';
            if (formData.precedentDiscussion) optDiscHtml += `<p><span class="review-label">Precedent Discussion:</span></p><pre class="review-value review-block">${escapeHtml(formData.precedentDiscussion)}</pre>`;
            if (formData.counterargumentDiscussion) optDiscHtml += `<p><span class="review-label">Counterargument Discussion:</span></p><pre class="review-value review-block">${escapeHtml(formData.counterargumentDiscussion)}</pre>`;
            if (formData.conclusion) optDiscHtml += `<p><span class="review-label">Conclusion:</span></p><pre class="review-value review-block">${escapeHtml(formData.conclusion)}</pre>`;
            if (optDiscHtml) reviewHtml += `<div class="review-section"><h3>Supporting Discussion</h3>${optDiscHtml}</div>`;
            else reviewHtml += `<div class="review-section"><h3>Supporting Discussion</h3><p><span class="review-value"><em>No optional discussion provided.</em></span></p></div>`;

            const intVotesProvided = [formData.internal_constitutional_votes, formData.internal_unconstitutional_votes, formData.internal_abstain_votes, formData.internal_did_not_vote, formData.internal_against_vote].some(v => v !== null && v !== undefined && v !== '');
            if (intVotesProvided) {
                reviewHtml += `<div class="review-section"><h3>Internal Votes</h3><ul class="review-list">`;
                if (formData.internal_constitutional_votes !== null && formData.internal_constitutional_votes !== undefined) reviewHtml += `<li><span class="review-label">Constitutional:</span> ${formData.internal_constitutional_votes}</li>`;
                if (formData.internal_unconstitutional_votes !== null && formData.internal_unconstitutional_votes !== undefined) reviewHtml += `<li><span class="review-label">Unconstitutional:</span> ${formData.internal_unconstitutional_votes}</li>`;
                if (formData.internal_abstain_votes !== null && formData.internal_abstain_votes !== undefined) reviewHtml += `<li><span class="review-label">Abstain:</span> ${formData.internal_abstain_votes}</li>`;
                if (formData.internal_did_not_vote !== null && formData.internal_did_not_vote !== undefined) reviewHtml += `<li><span class="review-label">Did Not Vote:</span> ${formData.internal_did_not_vote}</li>`;
                if (formData.internal_against_vote !== null && formData.internal_against_vote !== undefined) reviewHtml += `<li><span class="review-label">Votes Against Voting (Not in JSON):</span> ${formData.internal_against_vote}</li>`;
                reviewHtml += `</ul></div>`;
            } else { reviewHtml += `<div class="review-section"><h3>Internal Votes</h3><p><span class="review-value"><em>No internal votes provided.</em></span></p></div>`; }

            const allAddedRefs = [...(formData.manualRelevantArticles || []), ...(formData.manualOtherReferences || [])];
            if (allAddedRefs.length > 0) {
                reviewHtml += `<div class="review-section"><h3>References</h3><ul class="review-list review-references">`;
                const displayRefs = (refs, heading) => {
                    if (refs && refs.length > 0) {
                        reviewHtml += `<li class="review-subheading">${heading}:</li>`;
                        refs.forEach(ref => { let artTxt = ''; if (ref.isConstitution && ref.selectedArticles && ref.selectedArticles.length > 0) { artTxt = ` <span class="review-selected-articles">[Articles: ${escapeHtml(ref.selectedArticles.join(', '))}]</span>`; } reviewHtml += `<li><span class="review-label">${escapeHtml(ref.label)}:</span> <span class="ref-uri">${escapeHtml(ref.uri)}</span>${artTxt}</li>`; });
                    }
                };
                displayRefs(formData.manualRelevantArticles, 'Relevant Articles');
                displayRefs(formData.manualOtherReferences, 'Other References');
                reviewHtml += `</ul></div>`;
            } else { reviewHtml += `<div class="review-section"><h3>References</h3><p><span class="review-value"><em>No references added.</em></span></p></div>`; }
            reviewArea.innerHTML = reviewHtml;
        }

        function escapeHtml(str) { if (str === null || str === undefined) return ''; return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        function verifyMetadata() {
            const verStatus = document.getElementById('verification-status');
            const genBtn = document.getElementById('generate-button');
            const { isValid, message } = runFinalValidation();
            if (verStatus) { verStatus.textContent = message; verStatus.className = isValid ? 'success' : 'failure'; }
            if (genBtn) { genBtn.disabled = !isValid; }
        }

        function generateJson() {
            const errMsgDiv = document.getElementById('error-message');
            if (errMsgDiv) { errMsgDiv.textContent = ''; errMsgDiv.style.display = 'none'; }
            const genBtn = document.getElementById('generate-button');
            if (genBtn && genBtn.disabled) { if (errMsgDiv) { errMsgDiv.textContent = 'Please verify the metadata successfully before generating.'; errMsgDiv.style.display = 'block'; } return; }
            try {
                const metadataObject = buildMetadata();
                const jsonString = JSON.stringify(metadataObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const link = document.createElement('a');
                const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                const subjectText = formData.subject ? formData.subject.trim() : "Untitled";
                const safeSubject = subjectText.replace(/[<>:"/\\|?*]+/g, '_');
                link.download = `${formattedDate} - ${safeSubject}.JSON`;
                link.href = URL.createObjectURL(blob);
                document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error("Error generating JSON:", error);
                if (errMsgDiv) { errMsgDiv.textContent = `Error generating JSON: ${error.message}`; errMsgDiv.style.display = 'block'; }
            }
        }
    </script>
</body>
</html>
